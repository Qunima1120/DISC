---
title: "Cell type identification improvement"
output: html_notebook
---
### Setup knitr and load utility functions
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
```
```{r}
utilities_path = "./source/utilities.r"
source(utilities_path)
```
### Filtering cells as Seurat tutorial
Following <a href="https://satijalab.org/seurat/v3.0/pbmc3k_tutorial.html">Seurat tutorial</a>, we download original PBMC_3k data and filter cells.
```{r}
if(!file.exists("./data/pbmc3k/pbmc3k_filtered.loom")){
  temp <- tempfile()
  download.file("https://s3-us-west-2.amazonaws.com/10x.files/samples/cell/pbmc3k/pbmc3k_filtered_gene_bc_matrices.tar.gz", temp)
  exdir = "./data/pbmc3k"
  untar(temp, exdir = exdir)
  unlink(temp)
  original_data <- Read10X(data.dir = paste0(exdir, "/filtered_gene_bc_matrices/hg19/"))
  save_h5("./data/pbmc3k/pbmc3k.loom", as.matrix(t(original_data)))
  seurat_obj <- CreateSeuratObject(counts = as.data.frame(original_data), min.cells = 3, min.features = 200)
  seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
  seurat_obj <- subset(seurat_obj, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
  keep_cell_names = colnames(seurat_obj[["RNA"]]@counts)
  keep_gene_names = rownames(seurat_obj[["RNA"]]@counts)
  saveRDS(keep_gene_names, "./data/pbmc3k/used_gene_names.rds")
  raw_data = original_data[, keep_cell_names]
  save_h5("./data/pbmc3k/pbmc3k_filtered.loom", as.matrix(t(raw_data)))
}else{
  raw_data = readh5_loom("./data/pbmc3k/pbmc3k_filtered.loom")
}

```
### Classify cell types as Seurat tutorial
Following the <a href="https://satijalab.org/seurat/v3.0/pbmc3k_tutorial.html">Seurat tutorial</a>, we classify cells.
```{r fig.height=8, fig.width=11}
cell_type_identification = seurat_clustering(expression = raw_data, gene_selection_rds = "./data/pbmc3k/used_gene_names.rds", pca_dim = 10, res = 0.5, min_pct = 0.25, show = T, cell_type_identification_fun = cell_type_identification_pbmc)
cell_type= cell_type_identification$assignment
saveRDS(cell_type, "./data/pbmc3k/cell_type.rds")
```
### Load raw data and downsampling
The fraction of sampling is set to 30% of the original library size across cells.</br>
Only 1 replicate will be generated here as asn example.</br>
Only imputed genes will be kept for comparison.
```{r}
ds_dir = "./data/pbmc3k/ds_0.3"
dir.create(ds_dir, showWarnings = F, recursive = T)
observed_path = paste0(ds_dir, "/observed.loom")
if(!file.exists(observed_path)){
  observed_data = downsampling_cell(0.3, raw_data)
  save_h5(observed_path, t(observed_data))
}else{
  observed_data = readh5_loom(observed_path)
}
expressed_cell = rowSums(observed_data > 0)
gene_expression = rowSums(observed_data)
gene_filter = expressed_cell >= 10 & gene_expression > expressed_cell * 1
raw_data = raw_data[gene_filter, ]
observed_data = observed_data[gene_filter, ]
used_genes = rownames(observed_data)
print(dim(raw_data))
print(dim(observed_data))
data_list = list(Raw = raw_data, Observed = observed_data)
rm(raw_data, observed_data)
```
### Load downsampling data and imputation results
We <a href="https://github.com/iyhaoo/DISC/blob/master/reproducibility/tutorials/run_imputation.md">run imputation</a> using downsampling data.</br>
Here, we load the results.
```{r}
data_list[["DISC"]] = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)[used_genes, ]
print(dim(data_list[["DISC"]]))
data_list[["SAVER"]] = readh5_imputation(paste0(ds_dir, "/SAVER.hdf5"))
data_list[["MAGIC"]] = readh5_imputation(paste0(ds_dir, "/MAGIC.hdf5"))
data_list[["DCA"]] = readh5_imputation(paste0(ds_dir, "/DCA.hdf5"))
data_list[["scScope"]] = readh5_imputation(paste0(ds_dir, "/scScope.hdf5"))
data_list[["scVI"]] = readh5_imputation(paste0(ds_dir, "/scVI.hdf5"))
cell_number = ncol(data_list[["Raw"]])
gene_number = length(used_genes)
```
### Cell identification
```{r}
cell_type_identification_result_list = list()
for(ii in names(data_list)){
  cell_type_identification_result_list[[ii]] = seurat_clustering(expression = data_list[[ii]], cell_type = cell_type, pca_dim = 10, res = 0.5, min_pct = 0.25, show = T, cell_type_identification_fun = cell_type_identification_pbmc)
}
```
```{r fig.height=5, fig.width=4.5}
acc_result = rep(NA, length(cell_type_identification_result_list))
names(acc_result) = names(cell_type_identification_result_list)
ari_result = rep(NA, length(cell_type_identification_result_list))
names(ari_result) = names(cell_type_identification_result_list)
for(ii in names(cell_type_identification_result_list)){
  acc_result[ii] = cell_type_identification_result_list[[ii]][["summary"]]["ACC"]
  ari_result[ii] = cell_type_identification_result_list[[ii]][["summary"]]["ARI"]
}
method_names = names(cell_type_identification_result_list)
text_color = rep("black", length(method_names))
names(text_color) = method_names
text_color["DISC"] = "red"
bar_color = rep("gray50", length(method_names))
names(bar_color) = method_names
bar_color["Raw"] = "white"
bar_color["Observed"] = "gray80"
bar_color["DISC"] = "red"
barplot_usage(acc_result, main = "", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, ylab = "ACC", cex.lab = 1.5, font.main = 1, ylim = c(-0.1, 1), decreasing = TRUE)
barplot_usage(ari_result, main = "", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, ylab = "ARI", cex.lab = 1.5, font.main = 1, ylim = c(-0.1, 1), decreasing = TRUE)
```