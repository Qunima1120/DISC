acc_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
for(ii in names(cell_type_identification_result_list)){
jaccard_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "Jaccard"]
f1_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "F1-score"]
acc_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "ACC"]
}
cell_type_heatmap(jaccard_mat, "Jaccard")
cell_type_heatmap = function(method_type_mat, title){
ggplot(data = melt(method_type_mat), aes(x = Var2, y = Var1, fill = value)) + geom_tile() +
labs(x="Method", y = "Cell Type") + theme_classic() +
scale_fill_gradient(low='white',high='red') + geom_text(aes(Var2, Var1, label = round(value,2)), color = "black", size = 4) +
ggtitle(title) + scale_y_reverse()
theme(axis.text.x = element_text(size = 10,angle = 45, hjust = 1, vjust = 1),
axis.text.y = element_text(size = 10, hjust = 1, vjust = 1),
axis.title = element_text(size=12, face="bold"),
legend.title = element_blank(),
plot.title = element_text(size=14, face="bold"))
}
unique_cell_type = unique(cell_type)
jaccard_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
f1_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
acc_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
for(ii in names(cell_type_identification_result_list)){
jaccard_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "Jaccard"]
f1_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "F1-score"]
acc_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "ACC"]
}
cell_type_heatmap(jaccard_mat, "Jaccard")
cell_type_heatmap(f1_mat, "F1-score")
cell_type_heatmap(acc_mat, "ACC")
cell_type_heatmap = function(method_type_mat, title){
ggplot(data = melt(method_type_mat), aes(x = Var2, y = Var1, fill = value)) + geom_tile() +
labs(x="Method", y = "Cell Type") + theme_classic() +
scale_fill_gradient(low='white',high='red') + geom_text(aes(Var2, Var1, label = round(value,2)), color = "black", size = 4) +
ggtitle(title) + scale_y_reverse() +
theme(axis.text.x = element_text(size = 10,angle = 45, hjust = 1, vjust = 1),
axis.text.y = element_text(size = 10, hjust = 1, vjust = 1),
axis.title = element_text(size=12, face="bold"),
legend.title = element_blank(),
plot.title = element_text(size=14, face="bold"))
}
unique_cell_type = unique(cell_type)
jaccard_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
f1_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
acc_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
for(ii in names(cell_type_identification_result_list)){
jaccard_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "Jaccard"]
f1_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "F1-score"]
acc_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "ACC"]
}
cell_type_heatmap(jaccard_mat, "Jaccard")
cell_type_heatmap = function(method_type_mat, title){
ggplot(data = melt(method_type_mat), aes(x = Var2, y = Var1, fill = value)) + geom_tile() +
labs(x="Method", y = "Cell Type") + theme_classic() +
scale_fill_gradient(low='white',high='red') + geom_text(aes(Var2, Var1, label = round(value,2)), color = "black", size = 4) +
ggtitle(title) + scale_y_discrete(limits = rev(levels(Var1))) +
theme(axis.text.x = element_text(size = 10,angle = 45, hjust = 1, vjust = 1),
axis.text.y = element_text(size = 10, hjust = 1, vjust = 1),
axis.title = element_text(size=12, face="bold"),
legend.title = element_blank(),
plot.title = element_text(size=14, face="bold"))
}
unique_cell_type = unique(cell_type)
jaccard_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
f1_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
acc_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
for(ii in names(cell_type_identification_result_list)){
jaccard_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "Jaccard"]
f1_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "F1-score"]
acc_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "ACC"]
}
cell_type_heatmap(jaccard_mat, "Jaccard")
cell_type_heatmap = function(method_type_mat, title){
plot_df = melt(method_type_mat)
ggplot(data = plot_df, aes(x = Var2, y = Var1, fill = value)) + geom_tile() +
labs(x="Method", y = "Cell Type") + theme_classic() +
scale_fill_gradient(low='white',high='red') + geom_text(aes(Var2, Var1, label = round(value,2)), color = "black", size = 4) +
ggtitle(title) + scale_y_discrete(limits = rev(levels(plot_df$Var1))) +
theme(axis.text.x = element_text(size = 10,angle = 45, hjust = 1, vjust = 1),
axis.text.y = element_text(size = 10, hjust = 1, vjust = 1),
axis.title = element_text(size=12, face="bold"),
legend.title = element_blank(),
plot.title = element_text(size=14, face="bold"))
}
unique_cell_type = unique(cell_type)
jaccard_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
f1_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
acc_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
for(ii in names(cell_type_identification_result_list)){
jaccard_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "Jaccard"]
f1_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "F1-score"]
acc_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "ACC"]
}
cell_type_heatmap(jaccard_mat, "Jaccard")
cell_type_heatmap(f1_mat, "F1-score")
cell_type_heatmap(acc_mat, "ACC")
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
gene_bc_mat = as.matrix(read.csv("./data/CBMC/original_data/GSE100866_CBMC_8K_13AB_10X-RNA_umi.csv.gz", sep = ",", strip.white = T, row.names = 1))
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
if(!file.exists("./data/PBMC/raw.loom")){
temp <- tempfile()
download.file("http://cf.10xgenomics.com/samples/cell-exp/1.1.0/frozen_pbmc_donor_a/frozen_pbmc_donor_a_filtered_gene_bc_matrices.tar.gz", temp)
exdir = "./data/PBMC"
untar(temp, exdir = exdir)
unlink(temp)
original_data <- Read10X(data.dir = paste0(exdir, "/filtered_gene_bc_matrices/hg19/"))
save_h5("./data/PBMC/original.loom", as.matrix(t(original_data)))
seurat_obj <- CreateSeuratObject(counts = as.data.frame(original_data), min.cells = 3, min.features = 200)
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
seurat_obj <- subset(seurat_obj, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
keep_cell_names = colnames(seurat_obj[["RNA"]]@counts)
keep_gene_names = rownames(seurat_obj[["RNA"]]@counts)
saveRDS(keep_gene_names, "./results/PBMC/used_gene_names.rds")
raw_data = as.matrix(original_data[, keep_cell_names])
save_h5("./data/PBMC/raw.loom", t(raw_data))
}else{
raw_data = readh5_loom("./data/PBMC/raw.loom")
keep_gene_names = readRDS("./results/PBMC/used_gene_names.rds")
}
gene_mask = gsub(pattern = "_", replacement = "-", rownames(raw_data)) %in% keep_gene_names
cell_type_identification = seurat_classification(gene_bc_mat = raw_data[gene_mask, ], pca_dim = 10, res = 0.5, min_pct = 0.25, show_plots = T, cell_type_identification_fun = cell_type_identification_pbmc)
cell_type= cell_type_identification$assignment
saveRDS(cell_type, "./results/PBMC/cell_type.rds")
ds_dir = "./data/PBMC/ds_0.3"
dir.create(ds_dir, showWarnings = F, recursive = T)
observed_path = paste0(ds_dir, "/observed.loom")
if(!file.exists(observed_path)){
observed_data = downsampling_cell(0.3, raw_data)
save_h5(observed_path, t(observed_data))
}else{
observed_data = readh5_loom(observed_path)
}
data_list = list(Raw = raw_data, Observed = observed_data)
rm(raw_data, observed_data)
data_list[["DISC"]] = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)
data_list[["scImpute"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scImpute.hdf5")))
data_list[["VIPER"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/VIPER.hdf5")))
data_list[["MAGIC"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/MAGIC.hdf5")))
data_list[["DCA"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/DCA.hdf5")))
data_list[["DeepImpute"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/DeepImpute.hdf5")))
data_list[["scScope"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scScope.hdf5")))
data_list[["scVI"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scVI.hdf5")))
cell_number = ncol(data_list[["Raw"]])
gene_number = length(used_genes)
data_list[["DISC"]] = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
if(!file.exists("./data/PBMC/raw.loom")){
temp <- tempfile()
download.file("http://cf.10xgenomics.com/samples/cell-exp/1.1.0/frozen_pbmc_donor_a/frozen_pbmc_donor_a_filtered_gene_bc_matrices.tar.gz", temp)
exdir = "./data/PBMC"
untar(temp, exdir = exdir)
unlink(temp)
original_data <- Read10X(data.dir = paste0(exdir, "/filtered_gene_bc_matrices/hg19/"))
save_h5("./data/PBMC/original.loom", as.matrix(t(original_data)))
seurat_obj <- CreateSeuratObject(counts = as.data.frame(original_data), min.cells = 3, min.features = 200)
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
seurat_obj <- subset(seurat_obj, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
keep_cell_names = colnames(seurat_obj[["RNA"]]@counts)
keep_gene_names = rownames(seurat_obj[["RNA"]]@counts)
saveRDS(keep_gene_names, "./results/PBMC/used_gene_names.rds")
raw_data = as.matrix(original_data[, keep_cell_names])
save_h5("./data/PBMC/raw.loom", t(raw_data))
}else{
raw_data = readh5_loom("./data/PBMC/raw.loom")
keep_gene_names = readRDS("./results/PBMC/used_gene_names.rds")
}
gene_mask = gsub(pattern = "_", replacement = "-", rownames(raw_data)) %in% keep_gene_names
cell_type_identification = seurat_classification(gene_bc_mat = raw_data[gene_mask, ], pca_dim = 10, res = 0.5, min_pct = 0.25, show_plots = T, cell_type_identification_fun = cell_type_identification_pbmc)
cell_type= cell_type_identification$assignment
saveRDS(cell_type, "./results/PBMC/cell_type.rds")
ds_dir = "./data/PBMC/ds_0.3"
dir.create(ds_dir, showWarnings = F, recursive = T)
observed_path = paste0(ds_dir, "/observed.loom")
if(!file.exists(observed_path)){
observed_data = downsampling_cell(0.3, raw_data)
save_h5(observed_path, t(observed_data))
}else{
observed_data = readh5_loom(observed_path)
}
data_list = list(Raw = raw_data, Observed = observed_data)
rm(raw_data, observed_data)
data_list[["DISC"]] = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)
data_list[["scImpute"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scImpute.hdf5")))
data_list[["VIPER"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/VIPER.hdf5")))
data_list[["MAGIC"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/MAGIC.hdf5")))
data_list[["DCA"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/DCA.hdf5")))
data_list[["DeepImpute"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/DeepImpute.hdf5")))
data_list[["scScope"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scScope.hdf5")))
data_list[["scVI"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scVI.hdf5")))
for(ii in data_list){
print(dim(ii))
}
cell_type_identification_result_list = list()
for(ii in names(data_list)){
cell_type_identification_result_list[[ii]] = seurat_classification(gene_bc_mat = data_list[[ii]], cell_type = cell_type, pca_dim = 10, res = 0.5, min_pct = 0.25, show_plots = T, cell_type_identification_fun = cell_type_identification_pbmc)
}
ds_dir = "./data/PBMC/ds_0.3"
dir.create(ds_dir, showWarnings = F, recursive = T)
observed_path = paste0(ds_dir, "/observed.loom")
if(!file.exists(observed_path)){
observed_data = downsampling_cell(0.3, raw_data)
save_h5(observed_path, t(observed_data))
}else{
observed_data = readh5_loom(observed_path)
}
expressed_gene_mask = rowSums(raw_data) > 0
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
if(!file.exists("./data/PBMC/raw.loom")){
temp <- tempfile()
download.file("http://cf.10xgenomics.com/samples/cell-exp/1.1.0/frozen_pbmc_donor_a/frozen_pbmc_donor_a_filtered_gene_bc_matrices.tar.gz", temp)
exdir = "./data/PBMC"
untar(temp, exdir = exdir)
unlink(temp)
original_data <- Read10X(data.dir = paste0(exdir, "/filtered_gene_bc_matrices/hg19/"))
save_h5("./data/PBMC/original.loom", as.matrix(t(original_data)))
seurat_obj <- CreateSeuratObject(counts = as.data.frame(original_data), min.cells = 3, min.features = 200)
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
seurat_obj <- subset(seurat_obj, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
keep_cell_names = colnames(seurat_obj[["RNA"]]@counts)
keep_gene_names = rownames(seurat_obj[["RNA"]]@counts)
saveRDS(keep_gene_names, "./results/PBMC/used_gene_names.rds")
raw_data = as.matrix(original_data[, keep_cell_names])
save_h5("./data/PBMC/raw.loom", t(raw_data))
}else{
raw_data = readh5_loom("./data/PBMC/raw.loom")
keep_gene_names = readRDS("./results/PBMC/used_gene_names.rds")
}
gene_mask = gsub(pattern = "_", replacement = "-", rownames(raw_data)) %in% keep_gene_names
cell_type_identification = seurat_classification(gene_bc_mat = raw_data[gene_mask, ], pca_dim = 10, res = 0.5, min_pct = 0.25, show_plots = T, cell_type_identification_fun = cell_type_identification_pbmc)
cell_type= cell_type_identification$assignment
saveRDS(cell_type, "./results/PBMC/cell_type.rds")
ds_dir = "./data/PBMC/ds_0.3"
dir.create(ds_dir, showWarnings = F, recursive = T)
observed_path = paste0(ds_dir, "/observed.loom")
if(!file.exists(observed_path)){
observed_data = downsampling_cell(0.3, raw_data)
save_h5(observed_path, t(observed_data))
}else{
observed_data = readh5_loom(observed_path)
}
expressed_gene_mask = rowSums(raw_data) > 0
data_list = list(Raw = raw_data[expressed_gene_mask, ], Observed = observed_data[expressed_gene_mask, ])
rm(raw_data, observed_data)
data_list[["DISC"]] = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)[expressed_gene_mask, ]
data_list[["scImpute"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scImpute.hdf5")))
data_list[["VIPER"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/VIPER.hdf5")))
data_list[["MAGIC"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/MAGIC.hdf5")))
data_list[["DCA"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/DCA.hdf5")))
data_list[["DeepImpute"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/DeepImpute.hdf5")))
data_list[["scScope"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scScope.hdf5")))
data_list[["scVI"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scVI.hdf5")))
for(ii in names(data_list)){
print(dim(ii))
}
cell_type_identification_result_list = list()
for(ii in names(data_list)){
cell_type_identification_result_list[[ii]] = seurat_classification(gene_bc_mat = data_list[[ii]], cell_type = cell_type, pca_dim = 10, res = 0.5, min_pct = 0.25, show_plots = T, cell_type_identification_fun = cell_type_identification_pbmc)
}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
ds_dir = "./data/PBMC/ds_0.3"
observed_path = paste0(ds_dir, "/observed.loom")
observed_data = readh5_loom(observed_path)
expressed_cell = rowSums(observed_data > 0)
gene_expression = rowSums(observed_data)
gene_filter = expressed_cell >= 10 & gene_expression > expressed_cell * 1
used_genes = rownames(observed_data)[gene_filter]
DISC_values = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)
DISC_features = readh5_feature(paste0(ds_dir, "/DISC_feature.hdf5"))
cell_type = readRDS("./results/PBMC/cell_type.rds")
cell_type_identification = seurat_classification(gene_bc_mat = DISC_values, feature_bc_mat = DISC_features, cell_type = cell_type, pca_dim = 10, res = 0.5, min_pct = 0.25, show = T, cell_type_identification_fun = cell_type_identification_pbmc)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
ds_dir = "./data/PBMC/ds_0.3"
observed_path = paste0(ds_dir, "/observed.loom")
observed_data = readh5_loom(observed_path)
expressed_cell = rowSums(observed_data > 0)
gene_filter = expressed_cell > 0
DISC_values = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)[gene_filter, ]
DISC_features = readh5_feature(paste0(ds_dir, "/DISC_feature.hdf5"))
cell_type = readRDS("./results/PBMC/cell_type.rds")
cell_type_identification = seurat_classification(gene_bc_mat = DISC_values, feature_bc_mat = DISC_features, cell_type = cell_type, pca_dim = 10, res = 0.5, min_pct = 0.25, show = T, cell_type_identification_fun = cell_type_identification_pbmc)
print(cell_type_identification[["summary"]]["ACC"])
print(cell_type_identification[["summary"]]["ARI"])
print(cell_type_identification[["cell_type_result"]][, "Jaccard"])
print(cell_type_identification[["cell_type_result"]][, "F1-score"])
print(cell_type_identification[["cell_type_result"]][, "ACC"])
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
if(!file.exists("./data/BONE_MARROW/raw.loom")){
original_data <- readRDS("./data/BONE_MARROW/original_data/MantonBM6_count.rds")
save_h5("./data/BONE_MARROW/original.loom", as.matrix(t(original_data)))
seurat_obj <- CreateSeuratObject(counts = as.data.frame(original_data), min.features = 500)
cell_names = colnames(seurat_obj[["RNA"]]@counts)
gene_names = rownames(seurat_obj[["RNA"]]@counts)
raw_data = as.matrix(original_data[, cell_names])
save_h5("./data/BONE_MARROW/raw.loom", t(raw_data))
}else{
raw_data = readh5_loom("./data/BONE_MARROW/raw.loom")
cell_names = colnames(raw_data)
gene_names = rownames(raw_data)
}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
if(!file.exists("./data/BONE_MARROW/raw.loom")){
original_data <- readRDS("./data/BONE_MARROW/original_data/MantonBM6_count.rds")
save_h5("./data/BONE_MARROW/original.loom", as.matrix(t(original_data)))
seurat_obj <- CreateSeuratObject(counts = as.data.frame(original_data), min.features = 500)
cell_names = colnames(seurat_obj[["RNA"]]@counts)
gene_names = rownames(seurat_obj[["RNA"]]@counts)
raw_data = as.matrix(original_data[, cell_names])
save_h5("./data/BONE_MARROW/raw.loom", t(raw_data))
}else{
raw_data = readh5_loom("./data/BONE_MARROW/raw.loom")
cell_names = colnames(raw_data)
gene_names = rownames(raw_data)
}
print(dim(raw_data))
print("BONE_MARROW...OK!")
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
if(!file.exists("./data/PBMC/raw.loom")){
temp <- tempfile()
download.file("http://cf.10xgenomics.com/samples/cell-exp/1.1.0/frozen_pbmc_donor_a/frozen_pbmc_donor_a_filtered_gene_bc_matrices.tar.gz", temp)
exdir = "./data/PBMC"
untar(temp, exdir = exdir)
unlink(temp)
original_data <- Read10X(data.dir = paste0(exdir, "/filtered_gene_bc_matrices/hg19/"))
save_h5("./data/PBMC/original.loom", as.matrix(t(original_data)))
seurat_obj <- CreateSeuratObject(counts = as.data.frame(original_data), min.cells = 3, min.features = 200)
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
seurat_obj <- subset(seurat_obj, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
keep_cell_names = colnames(seurat_obj[["RNA"]]@counts)
keep_gene_names = rownames(seurat_obj[["RNA"]]@counts)
saveRDS(keep_gene_names, "./results/PBMC/used_gene_names.rds")
raw_data = as.matrix(original_data[, keep_cell_names])
save_h5("./data/PBMC/raw.loom", t(raw_data))
}else{
raw_data = readh5_loom("./data/PBMC/raw.loom")
keep_gene_names = readRDS("./results/PBMC/used_gene_names.rds")
}
cell_type_identification = seurat_classification(gene_bc_mat = raw_data[gsub(pattern = "_", replacement = "-", rownames(raw_data)) %in% keep_gene_names, ], pca_dim = 10, res = 0.5, min_pct = 0.25, show_plots = T, cell_type_identification_fun = cell_type_identification_pbmc)
cell_type= cell_type_identification$assignment
saveRDS(cell_type, "./results/PBMC/cell_type.rds")
ds_dir = "./data/PBMC/ds_0.3"
dir.create(ds_dir, showWarnings = F, recursive = T)
observed_path = paste0(ds_dir, "/observed.loom")
if(!file.exists(observed_path)){
observed_data = downsampling_cell(0.3, raw_data)
save_h5(observed_path, t(observed_data))
}else{
observed_data = readh5_loom(observed_path)
}
expressed_cell = rowSums(observed_data > 0)
gene_filter = expressed_cell > 0
data_list = list(Raw = raw_data[gene_filter, ], Observed = observed_data[gene_filter, ])
rm(raw_data, observed_data)
data_list[["DISC"]] = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)[gene_filter, ]
data_list[["scImpute"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scImpute.hdf5")))
data_list[["VIPER"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/VIPER.hdf5")))
data_list[["MAGIC"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/MAGIC.hdf5")))
data_list[["DCA"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/DCA.hdf5")))
data_list[["DeepImpute"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/DeepImpute.hdf5")))
data_list[["scScope"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scScope.hdf5")))
data_list[["scVI"]] = update_mat(data_list[["Observed"]], readh5_imputation(paste0(ds_dir, "/scVI.hdf5")))
for(ii in data_list){
print(dim(ii))
}
cell_type_identification_result_list = list()
for(ii in names(data_list)){
cell_type_identification_result_list[[ii]] = seurat_classification(gene_bc_mat = data_list[[ii]], cell_type = cell_type, pca_dim = 10, res = 0.5, min_pct = 0.25, show_plots = T, cell_type_identification_fun = cell_type_identification_pbmc)
}
acc_result = rep(NA, length(cell_type_identification_result_list))
names(acc_result) = names(cell_type_identification_result_list)
ari_result = rep(NA, length(cell_type_identification_result_list))
names(ari_result) = names(cell_type_identification_result_list)
for(ii in names(cell_type_identification_result_list)){
acc_result[ii] = cell_type_identification_result_list[[ii]][["summary"]]["ACC"]
ari_result[ii] = cell_type_identification_result_list[[ii]][["summary"]]["ARI"]
}
method_names = names(cell_type_identification_result_list)
text_color = rep("black", length(method_names))
names(text_color) = method_names
text_color["DISC"] = "red"
bar_color = rep("gray50", length(method_names))
names(bar_color) = method_names
bar_color["Raw"] = "white"
bar_color["Observed"] = "gray80"
bar_color["DISC"] = "red"
barplot_usage(acc_result, main = "", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, ylab = "ACC", cex.lab = 1.5, font.main = 1, ylim = c(-0.1, 1), decreasing = TRUE)
barplot_usage(ari_result, main = "", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, ylab = "ARI", cex.lab = 1.5, font.main = 1, ylim = c(-0.1, 1), decreasing = TRUE)
unique_cell_type = unique(cell_type)
jaccard_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
f1_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
acc_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
for(ii in names(cell_type_identification_result_list)){
jaccard_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "Jaccard"]
f1_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "F1-score"]
acc_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "ACC"]
}
cell_type_heatmap(jaccard_mat, "Jaccard")
cell_type_heatmap(f1_mat, "F1-score")
cell_type_heatmap(acc_mat, "ACC")
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
if(!file.exists("./data/PBMC/raw.loom")){
temp <- tempfile()
download.file("http://cf.10xgenomics.com/samples/cell-exp/1.1.0/frozen_pbmc_donor_a/frozen_pbmc_donor_a_filtered_gene_bc_matrices.tar.gz", temp)
exdir = "./data/PBMC"
untar(temp, exdir = exdir)
unlink(temp)
original_data <- Read10X(data.dir = paste0(exdir, "/filtered_gene_bc_matrices/hg19/"))
save_h5("./data/PBMC/original.loom", as.matrix(t(original_data)))
seurat_obj <- CreateSeuratObject(counts = as.data.frame(original_data), min.cells = 3, min.features = 200)
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
seurat_obj <- subset(seurat_obj, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
keep_cell_names = colnames(seurat_obj[["RNA"]]@counts)
keep_gene_names = rownames(seurat_obj[["RNA"]]@counts)
saveRDS(keep_gene_names, "./results/PBMC/used_gene_names.rds")
raw_data = as.matrix(original_data[, keep_cell_names])
save_h5("./data/PBMC/raw.loom", t(raw_data))
}else{
raw_data = readh5_loom("./data/PBMC/raw.loom")
keep_gene_names = readRDS("./results/PBMC/used_gene_names.rds")
}
cell_type_identification = seurat_classification(gene_bc_mat = raw_data[gsub(pattern = "_", replacement = "-", rownames(raw_data)) %in% keep_gene_names, ], pca_dim = 10, res = 0.5, min_pct = 0.25, show_plots = T, cell_type_identification_fun = cell_type_identification_pbmc)
cell_type= cell_type_identification$assignment
saveRDS(cell_type, "./results/PBMC/cell_type.rds")
ds_dir = "./data/PBMC/ds_0.3"
dir.create(ds_dir, showWarnings = F, recursive = T)
observed_path = paste0(ds_dir, "/observed.loom")
if(!file.exists(observed_path)){
observed_data = downsampling_cell(0.3, raw_data)
save_h5(observed_path, t(observed_data))
}else{
observed_data = readh5_loom(observed_path)
}
expressed_cell = rowSums(observed_data > 0)
gene_expression = rowSums(observed_data)
gene_filter = expressed_cell >= 10 & gene_expression > expressed_cell * 1
data_list = list(Raw = raw_data[gene_filter, ], Observed = observed_data[gene_filter, ])
rm(raw_data, observed_data)
data_list[["DISC"]] = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)[gene_filter, ]
data_list[["scImpute"]] = readh5_imputation(paste0(ds_dir, "/scImpute.hdf5"))
data_list[["VIPER"]] = readh5_imputation(paste0(ds_dir, "/VIPER.hdf5"))
data_list[["MAGIC"]] = readh5_imputation(paste0(ds_dir, "/MAGIC.hdf5"))
data_list[["DCA"]] = readh5_imputation(paste0(ds_dir, "/DCA.hdf5"))
data_list[["DeepImpute"]] = readh5_imputation(paste0(ds_dir, "/DeepImpute.hdf5"))
data_list[["scScope"]] = readh5_imputation(paste0(ds_dir, "/scScope.hdf5"))
data_list[["scVI"]] = readh5_imputation(paste0(ds_dir, "/scVI.hdf5"))
for(ii in data_list){
print(dim(ii))
}
cell_type_identification_result_list = list()
for(ii in names(data_list)){
cell_type_identification_result_list[[ii]] = seurat_classification(gene_bc_mat = data_list[[ii]], cell_type = cell_type, pca_dim = 10, res = 0.5, min_pct = 0.25, show_plots = T, cell_type_identification_fun = cell_type_identification_pbmc)
}
acc_result = rep(NA, length(cell_type_identification_result_list))
names(acc_result) = names(cell_type_identification_result_list)
ari_result = rep(NA, length(cell_type_identification_result_list))
names(ari_result) = names(cell_type_identification_result_list)
for(ii in names(cell_type_identification_result_list)){
acc_result[ii] = cell_type_identification_result_list[[ii]][["summary"]]["ACC"]
ari_result[ii] = cell_type_identification_result_list[[ii]][["summary"]]["ARI"]
}
method_names = names(cell_type_identification_result_list)
text_color = rep("black", length(method_names))
names(text_color) = method_names
text_color["DISC"] = "red"
bar_color = rep("gray50", length(method_names))
names(bar_color) = method_names
bar_color["Raw"] = "white"
bar_color["Observed"] = "gray80"
bar_color["DISC"] = "red"
barplot_usage(acc_result, main = "", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, ylab = "ACC", cex.lab = 1.5, font.main = 1, ylim = c(-0.1, 1), decreasing = TRUE)
barplot_usage(ari_result, main = "", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, ylab = "ARI", cex.lab = 1.5, font.main = 1, ylim = c(-0.1, 1), decreasing = TRUE)
unique_cell_type = unique(cell_type)
jaccard_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
f1_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
acc_mat = matrix(ncol = length(unique_cell_type), nrow = length(cell_type_identification_result_list), dimnames = list(names(cell_type_identification_result_list), unique_cell_type))
for(ii in names(cell_type_identification_result_list)){
jaccard_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "Jaccard"]
f1_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "F1-score"]
acc_mat[ii, ] = cell_type_identification_result_list[[ii]][["cell_type_result"]][, "ACC"]
}
cell_type_heatmap(jaccard_mat, "Jaccard")
cell_type_heatmap(f1_mat, "F1-score")
cell_type_heatmap(acc_mat, "ACC")
