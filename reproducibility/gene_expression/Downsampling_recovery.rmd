---
title: "Downsampling recovery"
output: html_notebook
---
### Setup knitr and load utility functions
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
```
```{r}
generic_functions_path = "./source/utility.r"
source(generic_functions_path)
```
### Load raw data and downsampling
Here, we use melanoma dataset as an example.</br>
The fraction of sampling is set to 50% of the original library size across cells.</br>
Only 1 replicate will be generated here as asn example.</br>
Only imputed genes will be kept for comparison.
```{r}
raw_data = readh5_loom("./data/melanoma/raw.loom")
ds_dir = "./data/melanoma/ds_0.5"
dir.create(ds_dir, showWarnings = F, recursive = T)
#observed_data = downsampling_cell(0.5, raw_data)
#save_h5(paste0(ds_dir, "/observed.loom"), t(observed_data))
observed_data = readh5_loom(paste0(ds_dir, "/observed.loom"))
expressed_cell = rowSums(observed_data > 0)
gene_expression = rowSums(observed_data)
gene_filter = expressed_cell >= 10 & gene_expression > expressed_cell * 1
raw_data = raw_data[gene_filter, ]
observed_data = observed_data[gene_filter, ]
used_genes = rownames(observed_data)
print(dim(raw_data))
print(dim(observed_data))
data_list = list(Raw = raw_data, Observed = observed_data)
rm(raw_data, observed_data)
```
### Load downsampling data and imputation results
We <a href="https://github.com/iyhaoo/DISC/blob/master/reproducibility/tutorials/run_imputation.md">run imputation</a>  using downsampling data.</br>
Here, we load their results.
```{r}
data_list[["DISC"]] = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)[used_genes, ]
print(dim(data_list[["DISC"]]))
data_list[["SAVER"]] = readh5_imputation(paste0(ds_dir, "/SAVER.hdf5"))
data_list[["MAGIC"]] = readh5_imputation(paste0(ds_dir, "/MAGIC.hdf5"))
data_list[["DCA"]] = readh5_imputation(paste0(ds_dir, "/DCA.hdf5"))
data_list[["scScope"]] = readh5_imputation(paste0(ds_dir, "/scScope.hdf5"))
data_list[["scVI"]] = readh5_imputation(paste0(ds_dir, "/scVI.hdf5"))
```
### Settings
```{r}
method_names = setdiff(names(data_list), "Raw")
method_color = c("gray80", "red", "blue4", "yellow4", "green", "purple", "cyan")
names(method_color) = method_names
text_color = rep("black", length(method_names))
names(text_color) = method_names
text_color["DISC"] = "red"
bar_color = rep("gray50", length(method_names))
names(bar_color) = method_names
bar_color["Raw"] = "gray80"
bar_color["DISC"] = "red"
```
### MAE
```{r}
output_dir = paste0(ds_dir, "/MAE")
dir.create(output_dir, showWarnings = F, recursive = T)
mae_gt0 = c()
mae_eq0 = c()
scale_factor = 1 / 0.5
for(this_method in method_names){
  eq0 = sum(data_list[["Raw"]] > 0 & data_list[["Observed"]] == 0)
  gt0 = sum(data_list[["Raw"]] > 0 & data_list[["Observed"]] > 0)
  sae_gt0 = sum(sapply(used_genes, function(x){
    expressed_mask = data_list[["Raw"]][x, ] > 0 & data_list[["Observed"]][x, ] > 0
    return(sum(abs(data_list[["Raw"]][x, expressed_mask] - (data_list[[this_method]][x, expressed_mask] * scale_factor))))
  }))
  sae_eq0 = sum(sapply(used_genes, function(x){
    expressed_mask = data_list[["Raw"]][x, ] > 0 & data_list[["Observed"]][x, ] == 0
    return(sum(abs(data_list[["Raw"]][x, expressed_mask] - (data_list[[this_method]][x, expressed_mask] * scale_factor))))
  }))
  mae_gt0 = c(mae_gt0, sae_gt0 / gt0)
  mae_eq0 = c(mae_eq0, sae_eq0 / eq0)
  print(this_method)
}
names(mae_gt0) = method_names
names(mae_eq0) = method_names
```
After <a href="https://github.com/iyhaoo/DISC/blob/master/reproducibility/tutorials/run_imputation.md">Run imputation</a>, we get imputation results.</br>
Now we load them.</br>
Note that SAVER needs to generate gene expression values following gamma distribution (FF, Gini CMD) or poissonâ€“gamma mixture (density distribution). For this reason, we load its rds-formatted file here.
```{r fig.height=5, fig.width=4.5}
barplot_usage(mae_eq0, main = "Zero entries", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, ylab = "Log (MAE + 1)", cex.lab = 1.5, font.main = 1)
```
