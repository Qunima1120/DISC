---
title: "Downsampling recovery"
output: html_notebook
---
### Setup knitr and load utility functions
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
```
```{r}
generic_functions_path = "./source/utility.r"
source(generic_functions_path)
```
### Load raw data and downsampling
Here, we use melanoma dataset as an example.</br>
The fraction of sampling is set to 50% of the original library size across cells.</br>
Only 1 replicate will be generated here as asn example.</br>
Only imputed genes will be kept for comparison.
```{r}
raw_data = readh5_loom("./data/melanoma/raw.loom")
ds_dir = "./data/melanoma/ds_0.5"
dir.create(ds_dir, showWarnings = F, recursive = T)
#observed_data = downsampling_cell(0.5, raw_data)
#save_h5(paste0(ds_dir, "/observed.loom"), t(observed_data))
observed_data = readh5_loom(paste0(ds_dir, "/observed.loom"))
expressed_cell = rowSums(observed_data > 0)
gene_expression = rowSums(observed_data)
gene_filter = expressed_cell >= 10 & gene_expression > expressed_cell * 1
raw_data = raw_data[gene_filter, ]
observed_data = observed_data[gene_filter, ]
used_genes = rownames(observed_data)
print(dim(raw_data))
print(dim(observed_data))
data_list = list(Raw = raw_data, Observed = observed_data)
rm(raw_data, observed_data)
```
### Load downsampling data and imputation results
We <a href="https://github.com/iyhaoo/DISC/blob/master/reproducibility/tutorials/run_imputation.md">run imputation</a>  using downsampling data.</br>
Here, we load their results.
```{r}
data_list[["DISC"]] = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)[used_genes, ]
print(dim(data_list[["DISC"]]))
data_list[["SAVER"]] = readh5_imputation(paste0(ds_dir, "/SAVER.hdf5"))
data_list[["MAGIC"]] = readh5_imputation(paste0(ds_dir, "/MAGIC.hdf5"))
data_list[["DCA"]] = readh5_imputation(paste0(ds_dir, "/DCA.hdf5"))
data_list[["scScope"]] = readh5_imputation(paste0(ds_dir, "/scScope.hdf5"))
data_list[["scVI"]] = readh5_imputation(paste0(ds_dir, "/scVI.hdf5"))
```
### Settings
```{r}
method_names = setdiff(names(data_list), "Raw")
method_color = c("gray80", "red", "blue4", "yellow4", "green", "purple", "cyan")
names(method_color) = method_names
text_color = rep("black", length(method_names))
names(text_color) = method_names
text_color["DISC"] = "red"
bar_color = rep("gray50", length(method_names))
names(bar_color) = method_names
bar_color["Raw"] = "gray80"
bar_color["DISC"] = "red"
```
### MAE
```{r}
output_dir = paste0(ds_dir, "/MAE")
dir.create(output_dir, showWarnings = F, recursive = T)
mae_gt0 = c()
mae_eq0 = c()
scale_factor = 1 / 0.5
for(this_method in method_names){
  eq0 = sum(data_list[["Raw"]] > 0 & data_list[["Observed"]] == 0)
  gt0 = sum(data_list[["Raw"]] > 0 & data_list[["Observed"]] > 0)
  sae_gt0 = sum(sapply(used_genes, function(x){
    expressed_mask = data_list[["Raw"]][x, ] > 0 & data_list[["Observed"]][x, ] > 0
    return(sum(abs(data_list[["Raw"]][x, expressed_mask] - (data_list[[this_method]][x, expressed_mask] * scale_factor))))
  }))
  sae_eq0 = sum(sapply(used_genes, function(x){
    expressed_mask = data_list[["Raw"]][x, ] > 0 & data_list[["Observed"]][x, ] == 0
    return(sum(abs(data_list[["Raw"]][x, expressed_mask] - (data_list[[this_method]][x, expressed_mask] * scale_factor))))
  }))
  mae_gt0 = c(mae_gt0, sae_gt0 / gt0)
  mae_eq0 = c(mae_eq0, sae_eq0 / eq0)
  print(this_method)
}
names(mae_gt0) = method_names
names(mae_eq0) = method_names
```
After <a href="https://github.com/iyhaoo/DISC/blob/master/reproducibility/tutorials/run_imputation.md">Run imputation</a>, we get imputation results.</br>
Now we load them.</br>
Note that SAVER needs to generate gene expression values following gamma distribution (FF, Gini CMD) or poissonâ€“gamma mixture (density distribution). For this reason, we load its rds-formatted file here.
```{r fig.height=5, fig.width=4.5}
barplot_usage(mae_eq0, main = "Zero entries", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, ylab = "Log (MAE + 1)", cex.lab = 1.5, font.main = 1)
```

### CMD
```{r}
replicates = paste0("downsampling_first_repeat_", seq(5))
#ds_mode = c("ds_0.3", "ds_0.5", "ds_0.7")
ds_mode = c("ds_0.5")
raw_path = "/home/yuanhao/data/fn/melanoma/dropseq_filt_ls.loom"
output_dir = paste0(stringi::stri_trim_right(raw_path, "[/]"), "CMD_vst_ds")
dir.create(output_dir, showWarnings = F, recursive = T)
gene_bc_mat = readh5_loom(raw_path)
vst_file = paste0(output_dir, "/vst_gene.tsv")
if(file.exists(vst_file)){
  hvg_info = read.table(vst_file)
  print("load vst_file")
}else{
  hvg_info = FindVariableFeatures_vst_by_genes(gene_bc_mat)
  hvg_info = hvg_info[order(hvg_info$variance.standardized, decreasing = T), ]
  write.table(hvg_info, paste0(output_dir, "/vst_gene.tsv"), sep = "\t", quote = F, row.names = T, col.names = T)
}
for(this_mode in ds_mode){
  cmd_mat = matrix(nrow = length(replicates), ncol = length(method_names), dimnames = list(replicates, method_names))
  raw_mat = gene_bc_mat
  compare_gene = rownames(raw_mat)
  for(ii in replicates){
    ds_path = paste0("/home/yuanhao/data/fn/melanoma/ds/", ii, "/imputation/dropseq_filt_ls_", this_mode, "_mc_10_mce_1.loom")
    compare_gene = intersect(compare_gene, get_loom_gene(ds_path))
  }
  use_genes = rownames(hvg_info[rownames(hvg_info) %in% compare_gene, ])[1:300]
  cat("use_genes: ", length(use_genes), "\n")
  raw_mat = raw_mat[use_genes, ]
  for(ii in replicates){
    cor_all = list()
    for(method in c("Raw", method_names)){
      cor_all[[method]] = list()
      cor_all[[method]] = matrix(nrow = length(use_genes), ncol = length(use_genes), dimnames = list(use_genes, use_genes))
    }
    for(method in c("Raw", method_names)){
      switch(method,
             Raw = {
               impute_result = raw_mat
             },
             Observed={
               impute_result = readh5_loom(paste0("/home/yuanhao/data/fn/melanoma/ds/", ii, "/imputation/dropseq_filt_ls_", this_mode, "_mc_10_mce_1.loom"))[use_genes, ]
             },
             "DeSCI"={
               impute_result = readh5_imputation(get_optimal_point33(paste0("/home/yuanhao/data/fn/melanoma/ds/", ii, "/DeSCI_2.7.4.33/", this_mode, "/log.txt")), with_outliers = T)[use_genes, ]
             },{
               impute_result = readh5_imputation(paste0("/home/yuanhao/data/fn/melanoma/ds/", ii, "/imputation/dropseq_filt_ls_", this_mode, "_", method, "_mc_10_mce_1.hdf5"))[use_genes, ]
             })
      this_mat = delect_lt0.5(impute_result)
      no_cores <- detectCores() - 1
      cl <- makeCluster(no_cores)
      clusterExport(cl, varlist = c("this_mat", "method"))
      return_list = parLapply(cl, seq(nrow(this_mat) - 1), function(x){
        return_vector = rep(NA, nrow(this_mat) - x)
        ii_express = this_mat[x, ]
        ii_mask = ii_express > 0
        for(jj in (x + 1):nrow(this_mat)){
          jj_express = this_mat[jj, ]
          if(method %in% c("")){
            express_mask = rep(T, length(ii_mask))
          }else{
            express_mask = ii_mask | jj_express > 0
          }
          if(sum(express_mask) > 0){
            this_corr = cor(ii_express[express_mask], jj_express[express_mask], use = "pairwise.complete.obs")
            if(is.na(this_corr)){
              return_vector[jj - x] = 0
            }else{
              return_vector[jj - x] = this_corr
            }
          }else{
            return_vector[jj - x] = 0
          }
        }
        return(list("return_vector" = return_vector))
      })
      stopCluster(cl)
      cor_all[[method]][1, 1] = 1
      for(jj in 1:length(return_list)){
        cor_all[[method]][jj, (jj + 1): nrow(this_mat)] = return_list[[jj]][["return_vector"]]
        cor_all[[method]][(jj + 1): nrow(this_mat), jj] = return_list[[jj]][["return_vector"]]
        cor_all[[method]][(jj + 1), (jj + 1)] = 1
      }
      print(method)
    }
    saveRDS(cor_all, paste0(output_dir, "/", ds_mode, "_", ii, "cor_all.rds"))
    for(method in method_names){
      cmd_mat[ii, method] = calc_cmd(cor_all[["Raw"]], cor_all[[method]])
    }
  }
  print(cmd_mat)
  saveRDS(cmd_mat, paste0(output_dir, "/", ds_mode, "_cmd.rds"))
  saveRDS(colMeans(cmd_mat), paste0(output_dir, "/", ds_mode, "_cmd_result.rds"))
}



```



### Gene correlation
```{r}
pcc <- matrix(0, nrow(data_list[["Raw"]]),3)
colnames(pcc) <- c("gene","pearson_value","p_value")
for(i in seq(nrow(data_list[["Raw"]]))){
	x <- vector()
	x <- as.numeric(data_list[["Raw"]][i,])
	index <-which(x!=0)
	x1 <-x[index]
	aa <-unique(x1)
	if(length(aa)!=1 & length(x1) >=(0.1*length(x))){
  	y <- vector()
  	y <- as.numeric(data_list[["Observed"]][i,])
  	y1 <-y[index]
  	cor <- cor.test(x1, y1, method = "pearson", alternative="two.sided")
  	p_value <- cor$p.value
  	pearson_value <- as.numeric(cor[4])
  	pcc[i, 1] <- rownames(data_list[["Observed"]])[i]
  	pcc[i, 2] <- pearson_value
  	pcc[i, 3] <- p_value
	}
	if(i %% 1000 == 0){
	  print(i)
	}
}
pcc <-pcc[which(pcc[,1]!="0"),]
mean(as.numeric(pcc[,2]))
```

### Cell correlation
```{r}

pcc <- matrix(0, ncol(data_list[["Raw"]]),3)
colnames(pcc) <- c("cell","pearson_value","p_value")
cnt_len <- ncol(data_list[["Raw"]])
for(i in 1:cnt_len){
	x <- vector()
	x <- as.numeric(data_list[["Raw"]][,i])
	index <-which(x!=0)
	x1 <-x[index]
	aa <-unique(x1)
	if(length(aa)!=1 & length(x1) >=(0.1*length(x))){
  	y <- vector()
  	y <- as.numeric(data_list[["Observed"]][,i])
  	y1 <-y[index]
  	cor <- cor.test(x1, y1, method = "pearson", alternative="two.sided")
  	p_value <- cor$p.value
  	pearson_value <- as.numeric(cor[4])
  	pcc[i, 1] <- colnames(data_list[["Observed"]])[i]
  	pcc[i, 2] <- pearson_value
  	pcc[i, 3] <- p_value
	}
	if(i %% 1000 == 0){
	  print(i)
	}
}
pcc <-pcc[which(pcc[,1]!="0"),]
mean(as.numeric(pcc[,2]))

```







