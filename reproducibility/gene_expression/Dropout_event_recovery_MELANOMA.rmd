---
title: "Dropout event recovery"
output: html_notebook
---
### Setup knitr and load utility functions
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
```
```{r}
utilities_path = "./source/utilities.r"
source(utilities_path)
```
### Load raw data and downsampling
Here, we use MELANOMA dataset as an example.</br>
The fraction of sampling is set to 50% of the original library size across cells.</br>
Only 1 replicate will be generated here as asn example.</br>
Only imputed genes will be kept for comparison.
```{r}
raw_data = readh5_loom("./data/MELANOMA/raw.loom")
ds_dir = "./data/MELANOMA/ds_0.5"
dir.create(ds_dir, showWarnings = F, recursive = T)
output_dir = "./results/MELANOMA/ds_0.5"
dir.create(output_dir, showWarnings = F, recursive = T)
observed_path = paste0(ds_dir, "/observed.loom")
if(!file.exists(observed_path)){
  observed_data = downsampling_cell(0.5, raw_data)
  save_h5(observed_path, t(observed_data))
}else{
  observed_data = readh5_loom(observed_path)
}
expressed_cell = rowSums(observed_data > 0)
gene_expression = rowSums(observed_data)
gene_filter = expressed_cell >= 10 & gene_expression > expressed_cell * 1
raw_data = raw_data[gene_filter, ]
observed_data = observed_data[gene_filter, ]
used_genes = rownames(observed_data)
print(dim(raw_data))
print(dim(observed_data))
data_list = list(Raw = raw_data, Observed = observed_data)
rm(raw_data, observed_data)
```
### Load downsampling data and imputation results
We <a href="https://github.com/iyhaoo/DISC/blob/master/reproducibility/tutorials/run_imputation.md">run imputation</a>  using downsampling data.</br>
Here, we load their results.
```{r}
data_list[["DISC"]] = readh5_imputation(paste0(ds_dir, "/DISC.hdf5"), with_outliers = T)[used_genes, ]
print(dim(data_list[["DISC"]]))
data_list[["SAVER"]] = readh5_imputation(paste0(ds_dir, "/SAVER.hdf5"))
data_list[["MAGIC"]] = readh5_imputation(paste0(ds_dir, "/MAGIC.hdf5"))
data_list[["DCA"]] = readh5_imputation(paste0(ds_dir, "/DCA.hdf5"))
data_list[["scScope"]] = readh5_imputation(paste0(ds_dir, "/scScope.hdf5"))
data_list[["scVI"]] = readh5_imputation(paste0(ds_dir, "/scVI.hdf5"))
cell_number = ncol(data_list[["Raw"]])
gene_number = length(used_genes)
```
### Settings
```{r}
method_names = setdiff(names(data_list), "Raw")
method_color = c("gray80", "#FF0000", "#000080", "#BFBF00", "#408000", "#804000", "#00FF00", "#FF8000", "#FF00FF", "#00FFFF")
names(method_color) = method_names
text_color = rep("black", length(method_names))
names(text_color) = method_names
text_color["DISC"] = "red"
bar_color = rep("gray50", length(method_names))
names(bar_color) = method_names
bar_color["Observed"] = "gray80"
bar_color["DISC"] = "red"
```
### MAE
```{r}
MAE_mat = matrix(nrow = cell_number, ncol = length(method_names), dimnames = list(c(), method_names))
ls_raw = colSums(data_list[["Raw"]])
for(ii in method_names){
  for(jj in repeats){
    ls_this = colSums(data_list[[ii]][[jj]])
    scale_factor = ls_raw / ls_this
    ERROR_MAE = sapply(seq(cell_number), function(x){
      expressed_mask = data_list[["Raw"]][, x] > 0
      expressed_number = sum(expressed_mask)
      error = data_list[["Raw"]][expressed_mask, x] - (data_list[[ii]][[jj]][expressed_mask, x] * scale_factor[x])
      return(sum(abs(error)) / expressed_number)
    })
    if(jj == repeats[1]){
      MAE_cell = ERROR_MAE
    }else{
      MAE_cell = cbind(MAE_cell, ERROR_MAE)
    }
  }
  MAE_mat[, ii] = rowMeans(MAE_cell)
  print(ii)
}
MAE_mat = MAE_mat[rowSums(is.na(MAE_mat)) < 1, ]
MAE_df = melt(t(MAE_mat))
MAE_levels = colnames(MAE_mat)[c(1, order(colMeans(MAE_mat)[-1], decreasing = F) + 1)]

```

```{r fig.height=5, fig.width=4.5}
ggplot(MAE_df, aes(x = factor(Var1, levels = MAE_levels), y = value, fill = factor(Var1, levels = MAE_levels))) +
  geom_boxplot(outlier.shape = NA) + stat_boxplot(geom = "errorbar", width = 0.3) +
  ylim(min(apply(MAE_mat, 2, quantile, 0.1)), max(apply(MAE_mat, 2, quantile, 0.9))) + theme_classic() +
  theme(axis.text.x = element_text(size = 12,angle = 45, hjust = 1, vjust = 1, face = "bold"),
        axis.text.y = element_text(size = 12, hjust = 1, vjust = 1, face = "bold"),
        legend.position = "none")
```

### CMD
```{r}
CMD_output_dir = paste0(output_dir, "/CMD")
dir.create(CMD_output_dir, showWarnings = F, recursive = T)
vst_file = paste0(CMD_output_dir, "/vst_gene.tsv")
if(file.exists(vst_file)){
  hvg_info = read.table(vst_file)
  print("load vst_file")
}else{
  hvg_info = FindVariableFeatures_vst_by_genes(data_list[["Raw"]])
  hvg_info = hvg_info[order(hvg_info$variance.standardized, decreasing = T), ]
  write.table(hvg_info, paste0(CMD_output_dir, "/vst_gene.tsv"), sep = "\t", quote = F, row.names = T, col.names = T)
}
used_feature_genes = rownames(hvg_info)[1:300]
cor_all = list()
for(ii in names(data_list)){
  if(ii == "Raw"){
    cor_all[[ii]] = calc_cor_mat(data_list[[ii]][used_feature_genes, ])
  }else{
    cor_all[[ii]] = list()
    for(jj in repeats){
      cor_all[[ii]][[jj]] = calc_cor_mat(delete_lt0.5(data_list[[ii]][[jj]])[used_feature_genes, ])
    }
  }
  print(ii)
}
saveRDS(cor_all, paste0(CMD_output_dir, "/cor_all.rds"))
cmd_mat = matrix(nrow = length(method_names), ncol = length(repeats), dimnames = list(method_names, repeats))
for(ii in method_names){
  for(jj in repeats){
    cmd_mat[ii, jj] = calc_cmd(cor_all[["Raw"]], cor_all[[ii]][[jj]])
  }
}

```
```{r fig.height=6, fig.width=5}
barplot_usage(rowMeans(cmd_mat), standard_error = apply(cmd_mat, 1, ste), main = "", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, ylab = "CMD", cex.lab = 1.5, font.main = 1, ylim = c(-0.1, 1))
```


### Gene correlation
```{r}
gene_corr_mat = matrix(nrow = gene_number, ncol = length(method_names), dimnames = list(c(), method_names))
for(ii in method_names){
  for(jj in repeats){
    if(jj == repeats[1]){
      cor_mat = calc_corr(data_list[["Raw"]], data_list[[ii]][[jj]], "gene")
    }else{
      cor_mat = cbind(cor_mat, calc_corr(data_list[["Raw"]], data_list[[ii]][[jj]], "gene"))
    }
  }
  gene_corr_mat[, ii] = rowMeans(cor_mat)
  print(ii)
}
gene_corr_mat = gene_corr_mat[rowSums(is.na(gene_corr_mat)) < 1, ]

```
```{r fig.height=6, fig.width=5}
boxplot_usage(gene_corr_mat, main = "", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, decreasing = T, ylab = "Gene correlation with reference", cex.lab = 1.5, font.main = 1, ylim = c(-0.1, 1))
```
### Cell correlation
```{r}
cell_corr_mat = matrix(nrow = cell_number, ncol = length(method_names), dimnames = list(c(), method_names))
for(ii in method_names){
  for(jj in repeats){
    if(jj == repeats[1]){
      cor_mat = calc_corr(data_list[["Raw"]], data_list[[ii]][[jj]], "cell")
    }else{
      cor_mat = cbind(cor_mat, calc_corr(data_list[["Raw"]], data_list[[ii]][[jj]], "cell"))
    }
  }
  cell_corr_mat[, ii] = rowMeans(cor_mat)
  print(ii)
}
cell_corr_mat = cell_corr_mat[rowSums(is.na(cell_corr_mat)) < 1, ]

```
```{r fig.height=5, fig.width=4.5}
boxplot_usage(cell_corr_mat, main = "", cex.main = 1.5, bar_color = bar_color, text_color = text_color, use_data_order = T, decreasing = T, ylab = "Cell correlation with reference", cex.lab = 1.5, font.main = 1, ylim = c(-0.1, 1))
```







