knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
if(!file.exists("./data/BONE_MARROW/raw.loom")){
original_data <- readRDS("./data/BONE_MARROW/original_data/MantonBM6_count.rds")
save_h5("./data/BONE_MARROW/original.loom", as.matrix(t(original_data)))
seurat_obj <- CreateSeuratObject(counts = as.data.frame(original_data), min.features = 500)
cell_names = colnames(seurat_obj[["RNA"]]@counts)
gene_names = rownames(original_data)
raw_data = as.matrix(original_data[, cell_names])
save_h5("./data/BONE_MARROW/raw.loom", t(raw_data))
}else{
raw_data = readh5_loom("./data/BONE_MARROW/raw.loom")
cell_names = colnames(raw_data)
gene_names = rownames(raw_data)
}
print(dim(raw_data))
print("BONE_MARROW...OK!")
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="E:/DISC/reproducibility")
utilities_path = "./source/utilities.r"
source(utilities_path)
if(!file.exists("./data/PBMC_TISSUE/raw.loom")){
original_data_dir = "./data/PBMC_TISSUE/orignial_data"
filelist = list.files(original_data_dir)
filelist = filelist[grepl(".tar.gz", filelist)]
gene_name_list = list()
cell_id_list = list()
cell_type = c()
for(ii in filelist){
print(ii)
exdir = paste0(original_data_dir, "/", sub(".tar.gz", "", ii))
dir.create(exdir, showWarnings = F)
untar(paste0(original_data_dir, "/", ii), exdir = exdir)
gene_id_gene_name = read.table(paste0(exdir, "/filtered_matrices_mex/hg19/genes.tsv"))
gene_name_list[[ii]] = paste0(gene_id_gene_name[, 1],':',gene_id_gene_name[, 2])
this_cell_type = sub("_filtered_gene_bc_matrices.tar.gz", "", ii)
cell_id_list[[ii]] = paste0(this_cell_type, ':', readLines(paste0(exdir, "/filtered_matrices_mex/hg19/barcodes.tsv")))
cell_type = c(cell_type, rep(this_cell_type, length(cell_id_list[[ii]])))
}
gene_name = unique(unlist(gene_name_list))
cell_id = unlist(cell_id_list)
names(cell_type) = cell_id
original_data = Matrix(0, nrow = length(gene_name), ncol = length(cell_id), dimnames = list(gene_name, cell_id), sparse = T)
for(ii in filelist){
print(ii)
this_dgt_mat = readMM(paste0(original_data_dir, "/", sub(".tar.gz", "", ii), "/filtered_matrices_mex/hg19/matrix.mtx"))
rownames(this_dgt_mat) = gene_name_list[[ii]]
original_data[, cell_id_list[[ii]]] = as(this_dgt_mat[gene_name, ], "dgCMatrix")
}
gene_name_filt = gene_name[rowSums(original_data) > 0]
original_data = original_data[gene_name_filt, ]
print(dim(original_data))  # [21952, 94655]
save_h5("./data/PBMC_TISSUE/original.loom", as.matrix(t(original_data)))
saveRDS(cell_type, "./data/PBMC_TISSUE/cell_type_original.rds")
gn = sub(".*:", "", gene_name_filt)
rs <- rowSums(original_data)
kid <- sapply(unique(gn),function(sid) {
tmp <- which(gn==sid)
if (length(tmp)==1) {
tmp
} else {
tmp[which.max(rs[tmp])]
}
})
compare_genes = setdiff(kid, grep(":MT-", gene_name_filt))
#summary(colSums(original_data[compare_genes, ] > 0))
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#   142.0   457.0   545.0   626.2   674.0  3765.0
#summary(rowSums(original_data[compare_genes, ] > 0))
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#       1      13     254    2706    1738   94632
cell_mask = colSums(original_data[compare_genes, ] > 0) >= 500
raw_data = original_data[, cell_mask]
raw_cell_type = cell_type[cell_mask]
print(dim(raw_data))  # [21952, 59620]
save_h5("./data/PBMC_TISSUE/raw.loom", as.matrix(t(raw_data)))
saveRDS(raw_cell_type, "./data/PBMC_TISSUE/cell_type_raw.rds")
}else{
raw_data = readh5_loom("./data/PBMC_TISSUE/raw.loom")
print(dim(raw_data))
cell_id = colnames(raw_data)
gene_name = rownames(raw_data)
}
print("PBMC_TISSUE...OK!")
